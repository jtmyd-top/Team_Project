{% extends 'base.html' %}
{% load static %}

{% block title %}知识笔记{% endblock %}

{% block head_extra %}
<script src="{% static 'tinymce/tinymce.min.js' %}"></script>
<script src="{% static 'tinymce/langs/zh_CN.js' %}"></script>
<link href="{% static 'css/contents.css' %}" rel="stylesheet">
<!-- !!! 关键：已移除不兼容的第三方插件 tinymce-plugin.min.js !!! -->
<link href="{% static 'css/knowledge.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="knowledge-app" class="knowledge-root" v-cloak>
    <!-- 吐司提示框 -->
    <transition name="toast-fade">
        <div v-if="toast.visible" class="toast-notification" :class="'toast-' + toast.type">
            <i v-if="toast.type === 'success'" class="fas fa-check-circle"></i>
            <i v-if="toast.type === 'error'" class="fas fa-exclamation-circle"></i>
            <span>[[ toast.message ]]</span>
        </div>
    </transition>
    <!-- 确认对话框 -->
    <transition name="confirm-fade">
        <div v-if="confirmDialog.visible" class="confirm-dialog">
            <span>[[ confirmDialog.message ]]</span>
            <div class="confirm-dialog-actions">
                <button @click="confirmDialog.onCancel()" class="btn-cancel-confirm">取消</button>
                <button @click="confirmDialog.onConfirm()" class="btn-confirm-action">确定</button>
            </div>
        </div>
    </transition>
   <!-- 侧边栏 -->
    <aside class="sidebar" :class="{ 'collapsed': isSidebarCollapsed }">
        <button class="sidebar-toggle" title="展开/收起" @click="toggleSidebar" type="button" onclick="test()">
            <i :class="iconClass" id="chevron" ></i>
        </button>
        <div class="sidebar-content">
          <!-- 新建笔记按钮 (功能已暂时禁用) -->
          <a href="#" class="new-note-btn" title="新建笔记" @click.prevent="openNewNoteEditor">
            <i class="fas fa-plus"></i>
            <span v-show="!isSidebarCollapsed">新建笔记</span>
          </a>
          <div class="list-header" v-show="!isSidebarCollapsed">
              <h3>我的笔记</h3>
          </div>
          <ul class="notes-nav-list">
            <li v-for="note in sidebarNotes" :key="note.id" :class="{ 'active': selectedNoteId === note.id }">
              <a href="#" @click.prevent="selectNote(note.id)" :title="note.title">
                  <i class="far fa-file-alt"></i>
                  <span v-show="!isSidebarCollapsed">[[ note.title ]]</span>
              </a>
            </li>
          </ul>
          <!-- 搜索框 -->
          <div class="sidebar-search" title="搜索" @click="handleSearchClickWhenCollapsed">
            <i class="fas fa-search" ></i>
             <input v-show="!isSidebarCollapsed" type="text" placeholder="搜索我的笔记..." v-model="searchQuery" @blur="searchNotes" @keyup.enter="searchNotes" >
          </div>
        </div>
    </aside>

    <!-- 主内容区域 -->
    <main class="main-content">
        <div v-if="isLoading" class="loading-spinner" style="margin:auto;text-align:center;"><i class="fas fa-spinner fa-spin"></i> 正在加载...</div>

        <!-- 预览模式 -->
        <div v-else-if="selectedNote && !isEditing" class="note-preview">
            <div class="note-header">
                <div class="note-title-meta">
                    <h1>[[ selectedNote.title ]]</h1>
                    <div class="note-meta">
                        <span v-if="selectedNote.project">项目: [[ selectedNote.project.title ]]</span>
                        <span v-else>项目: 未分配</span>
                        | <span>创建于: [[ selectedNote.created_at ]]</span>
                    </div>
                </div>
                <div class="note-actions">
                    <button class="action-btn" @click="startEditing" title="编辑笔记" :disabled="isLoading"><i class="fas fa-pen"></i><span>编辑</span></button>
                    <label :disabled="isLoading" class="action-btn share-toggle-label" :class="{ 'is-public': selectedNote.is_public }" title="设为公开或私密">
                        <input type="checkbox" class="share-toggle-checkbox" v-model="selectedNote.is_public" @change="updateNote(false)">
                        <i :class="selectedNote.is_public ? 'fas fa-lock-open' : 'fas fa-share-alt'"></i>
                        <span>[[ selectedNote.is_public ? '已公开' : '分享' ]]</span>
                    </label>
                    <button v-if="selectedNote.is_public" class="action-btn" @click="copyPublicUrl" title="复制公开链接">
                         <i :class="copyStatus === 'copied' ? 'fas fa-check' : 'fas fa-copy'"></i>
                         <span>[[ copyStatus === 'copied' ? '已复制!' : '复制链接' ]]</span>
                    </button>
                </div>
            </div>

            <!-- !!! 关键：添加此 div 用于显示笔记内容 !!! -->
            <div class="note-content" v-html="selectedNote.content"></div>

            <!-- 找到这个 div 并用下面的代码块替换它 -->
<div v-if="totalPages > 1" class="pagination-controls">
    <!-- 上一页按钮 (保持不变) -->
    <button @click="prevPage" :disabled="currentPage === 1" class="action-btn" style="margin-right: 10px;">
        <i class="fas fa-chevron-left"></i>
        <span>上一页</span>
    </button>

    <!-- !!! 关键修改：可编辑的页码区域 !!! -->
    <div class="page-selector">
        <!-- 预览模式：显示页码，点击可进入编辑 -->
        <span v-if="!isEditingPageNumber" @click="editPageNumber" title="点击输入页码" class="page-display">
            页 [[ currentPage ]] / [[ totalPages ]]
        </span>
        <!-- 编辑模式：显示输入框 -->
        <input v-else
               ref="pageInputRef"
               type="number"
               class="page-input"
               v-model="pageInputNumber"
               @keyup.enter="goToPage"
               @blur="goToPage"
        />
    </div>

    <!-- 下一页按钮 (保持不变) -->
    <button @click="nextPage" :disabled="currentPage === totalPages" class="action-btn" style="margin-left: 10px;">
        <span>下一页</span>
        <i class="fas fa-chevron-right"></i>
    </button>
</div></div>

         <!-- 编辑模式 -->
        <div v-else-if="selectedNote && isEditing" class="edit-mode">

            <div class="edit-header">
                <input type="text" v-model="selectedNote.title" placeholder="请输入笔记标题...">
                <div class="edit-actions">
                    <button @click="cancelEditing" class="btn-cancel">取消</button>
                    <button @click="updateNote(true)" class="btn-save">保存更改</button>
                </div>
            </div>
            <textarea id="editor" ref="editorElRef"></textarea>
        </div>

        <!-- 默认空状态 -->
        <div v-else class="empty-state">
          <h2>选择一篇笔记开始阅读</h2>
          <p>或者，点击左上角的“新建笔记”来记录新的灵感。</p>
        </div>
       </main>
</div>
{% endblock %}

{% block scripts %}
    {{ initial_data|json_script:"initial-data" }}
    <script src="{% static 'JS/knowledge_app.js' %}"></script>
{% endblock %}